import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable, of, delay } from 'rxjs';

export interface Book {
  id: number;
  title: string;
  author: string;
  description: string;
  cover_image: string;
  pages: number;
  language: string;
  rating: number;
  category_id?: number;
}

export interface BooksResponse {
  books: Book[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

@Injectable({
  providedIn: 'root'
})
export class BookService {
  private apiUrl = '/api/books';

  // Фейковые данные
  private fakeBooks: Book[] = [
    {
      id: 1,
      title: 'Война и мир',
      author: 'Лев Толстой',
      description: 'Эпический роман-эпопея Льва Толстого, описывающий русское общество в эпоху войн против Наполеона в 1805—1812 годах. Центральное место в романе занимает изображение Отечественной войны 1812 года и её влияние на судьбы героев. Роман охватывает широкий спектр тем: от семейных отношений до философских размышлений о смысле жизни, от любви и дружбы до войны и смерти. Толстой мастерски показывает внутренний мир своих героев, их духовные искания и нравственное развитие. Это произведение считается одним из величайших романов в мировой литературе.',
      cover_image: '',
      pages: 1225,
      language: 'ru',
      rating: 4.8,
      category_id: 1
    },
    {
      id: 2,
      title: 'Преступление и наказание',
      author: 'Фёдор Достоевский',
      description: 'Психологический роман Фёдора Достоевского, повествующий о бывшем студенте Родионе Раскольникове, который решается на убийство ради проверки своей теории о "праве сильной личности". Роман исследует темы морали, совести, искупления и человеческой природы. Достоевский глубоко анализирует психологию преступника, показывая внутреннюю борьбу между рациональным обоснованием преступления и нравственным чувством. Через образы Сони Мармеладовой и следователя Порфирия Петровича автор показывает пути духовного спасения и нравственного возрождения.',
      cover_image: '',
      pages: 671,
      language: 'ru',
      rating: 4.9,
      category_id: 1
    },
    {
      id: 3,
      title: 'Мастер и Маргарита',
      author: 'Михаил Булгаков',
      description: 'Философский роман Михаила Булгакова, сочетающий в себе сатиру, фантастику и глубокие размышления о добре и зле. Действие происходит в двух временных пластах: в Москве 1930-х годов, куда приезжает дьявол со своей свитой, и в древнем Иерусалиме, где разворачивается история прокуратора Понтия Пилата и Иешуа Га-Ноцри. Роман исследует темы любви, предательства, творчества и вечной борьбы между светом и тьмой. Образы Воланда, Мастера и Маргариты стали символами русской литературы XX века.',
      cover_image: '',
      pages: 592,
      language: 'ru',
      rating: 4.7,
      category_id: 2
    },
    {
      id: 4,
      title: '1984',
      author: 'Джордж Оруэлл',
      description: 'Антиутопический роман Джорджа Оруэлла, описывающий тоталитарное общество будущего, где правительство полностью контролирует жизнь граждан через систему постоянного наблюдения и пропаганды. Главный герой Уинстон Смит работает в Министерстве правды, где занимается переписыванием истории. Роман исследует темы тоталитаризма, манипуляции сознанием, потери индивидуальности и свободы мысли. Фразы "Большой Брат смотрит на тебя" и "Война — это мир, свобода — это рабство, незнание — это сила" стали символами антиутопической литературы.',
      cover_image: '',
      pages: 328,
      language: 'en',
      rating: 4.6,
      category_id: 2
    },
    {
      id: 5,
      title: 'Гарри Поттер и философский камень',
      author: 'Дж. К. Роулинг',
      description: 'Первая книга знаменитой серии о юном волшебнике Гарри Поттере. История начинается с того, что одиннадцатилетний мальчик узнаёт, что он волшебник и зачислен в школу магии Хогвартс. Вместе с новыми друзьями Роном Уизли и Гермионой Грейнджер Гарри исследует волшебный мир, изучает магию и раскрывает тайну философского камня. Книга сочетает в себе элементы приключенческого романа, детектива и сказки, создавая увлекательный мир, полный магии, дружбы и отваги. Это история о взрослении, преодолении трудностей и силе настоящей дружбы.',
      cover_image: '',
      pages: 320,
      language: 'ru',
      rating: 4.9,
      category_id: 3
    },
    {
      id: 6,
      title: 'Алиса в Стране чудес',
      author: 'Льюис Кэрролл',
      description: 'Сказочная повесть Льюиса Кэрролла о приключениях девочки Алисы, которая попадает в фантастический мир через кроличью нору. В Стране чудес Алиса встречает множество необычных персонажей: Белого Кролика, Чеширского Кота, Безумного Шляпника, Королеву Червей и многих других. Книга полна абсурда, логических парадоксов и игры слов, что делает её интересной как для детей, так и для взрослых. Произведение считается классикой детской литературы и оказало огромное влияние на мировую культуру, породив множество адаптаций и интерпретаций.',
      cover_image: '',
      pages: 192,
      language: 'ru',
      rating: 4.5,
      category_id: 3
    },
    {
      id: 7,
      title: 'Анна Каренина',
      author: 'Лев Толстой',
      description: 'Роман Льва Толстого о трагической любви замужней дамы Анны Карениной и блестящего офицера Алексея Вронского на фоне жизни высшего общества Санкт-Петербурга и Москвы второй половины XIX века. Параллельно развивается история помещика Константина Левина, который ищет смысл жизни и пытается найти своё место в мире. Роман исследует темы любви, брака, семьи, общества и морали. Толстой мастерски показывает внутренний мир героев, их страсти, сомнения и нравственные искания. Это произведение считается одним из величайших романов мировой литературы.',
      cover_image: '',
      pages: 864,
      language: 'ru',
      rating: 4.8,
      category_id: 1
    },
    {
      id: 8,
      title: 'Братья Карамазовы',
      author: 'Фёдор Достоевский',
      description: 'Последний и самый масштабный роман Фёдора Достоевского, повествующий о трёх братьях Карамазовых и их отце. Роман исследует глубокие философские и религиозные вопросы: существование Бога, свобода воли, мораль и грех. Каждый из братьев представляет разные аспекты человеческой природы: Дмитрий — страсть и эмоции, Иван — интеллект и сомнения, Алёша — веру и духовность. Роман включает знаменитую главу "Великий инквизитор", которая считается одним из величайших философских текстов в мировой литературе. Это произведение оказало огромное влияние на развитие философии и литературы.',
      cover_image: '',
      pages: 824,
      language: 'ru',
      rating: 4.9,
      category_id: 1
    },
    {
      id: 9,
      title: 'Собачье сердце',
      author: 'Михаил Булгаков',
      description: 'Сатирическая повесть Михаила Булгакова о профессоре Преображенском, который проводит эксперимент по пересадке гипофиза человека собаке. В результате операции пёс Шарик превращается в человека Полиграфа Полиграфовича Шарикова, который становится воплощением худших качеств донора. Повесть является острой сатирой на советское общество 1920-х годов и критикой попыток насильственного создания "нового человека". Булгаков мастерски показывает абсурдность таких экспериментов и их разрушительные последствия. Произведение было запрещено к публикации в СССР и впервые опубликовано только в 1987 году.',
      cover_image: '',
      pages: 192,
      language: 'ru',
      rating: 4.7,
      category_id: 2
    },
    {
      id: 10,
      title: 'Скотный двор',
      author: 'Джордж Оруэлл',
      description: 'Аллегорическая повесть-притча Джорджа Оруэлла о группе животных, которые восстают против своих хозяев-людей и создают собственное общество. Изначально животные стремятся к равенству и справедливости, но постепенно свиньи, возглавляемые Наполеоном, захватывают власть и устанавливают диктатуру, которая оказывается ещё хуже, чем правление людей. Повесть является сатирой на сталинизм и тоталитарные режимы в целом. Оруэлл показывает, как революционные идеалы могут быть извращены и использованы для установления новой тирании. Это произведение стало классикой политической сатиры и антиутопической литературы.',
      cover_image: '',
      pages: 112,
      language: 'en',
      rating: 4.8,
      category_id: 2
    },
    {
      id: 11,
      title: 'Гарри Поттер и Тайная комната',
      author: 'Дж. К. Роулинг',
      description: 'Вторая книга серии о Гарри Поттере, в которой герой возвращается в Хогвартс на второй год обучения. В школе начинают происходить загадочные события: ученики оказываются окаменевшими, а на стенах появляются угрожающие надписи о том, что Тайная комната открыта. Гарри, Рон и Гермиона расследуют эти события и обнаруживают связь с тёмным прошлым Хогвартса. Книга развивает темы дружбы, верности и мужества, а также знакомит читателей с новыми персонажами и магическими существами. Это захватывающее продолжение истории о юном волшебнике, полное приключений и тайн.',
      cover_image: '',
      pages: 352,
      language: 'ru',
      rating: 4.9,
      category_id: 3
    },
    {
      id: 12,
      title: 'Властелин колец: Братство Кольца',
      author: 'Дж. Р. Р. Толкин',
      description: 'Первая часть эпической трилогии Джона Рональда Руэла Толкина о Средиземье. История повествует о хоббите Фродо Бэггинсе, который получает в наследство Кольцо Всевластья — могущественный артефакт тёмного владыки Саурона. Фродо отправляется в опасное путешествие, чтобы уничтожить Кольцо в пламени Роковой Горы, где оно было выковано. Его сопровождают верные друзья: Сэм, Мерри, Пиппин, а также Арагорн, Леголас, Гимли, Боромир и Гэндальф. Роман сочетает в себе элементы эпического фэнтези, приключенческого романа и философской притчи о борьбе добра со злом.',
      cover_image: '',
      pages: 576,
      language: 'ru',
      rating: 4.9,
      category_id: 3
    }
  ];

  constructor(private http: HttpClient) {}

  getBooks(params?: {
    page?: number;
    limit?: number;
    search?: string;
    category?: string;
    sort?: string;
    order?: 'asc' | 'desc';
  }): Observable<BooksResponse> {
    // Фейковые данные
    let books = [...this.fakeBooks];
    const page = params?.page || 1;
    const limit = params?.limit || 10;

    // Фильтрация по поиску
    if (params?.search) {
      const searchLower = params.search.toLowerCase();
      books = books.filter(book => 
        book.title.toLowerCase().includes(searchLower) ||
        book.author.toLowerCase().includes(searchLower)
      );
    }

    // Фильтрация по категории
    if (params?.category) {
      books = books.filter(book => book.category_id?.toString() === params.category);
    }

    // Сортировка
    if (params?.sort) {
      books.sort((a, b) => {
        const aVal = a[params.sort as keyof Book] as any;
        const bVal = b[params.sort as keyof Book] as any;
        const comparison = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        return params.order === 'desc' ? -comparison : comparison;
      });
    }

    // Пагинация
    const start = (page - 1) * limit;
    const end = start + limit;
    const paginatedBooks = books.slice(start, end);

    const response: BooksResponse = {
      books: paginatedBooks,
      pagination: {
        page,
        limit,
        total: books.length,
        totalPages: Math.ceil(books.length / limit)
      }
    };

    return of(response).pipe(delay(300));
  }

  getBookById(id: number): Observable<Book> {
    // Фейковые данные
    const book = this.fakeBooks.find(b => b.id === id);
    if (book) {
      return of(book).pipe(delay(300));
    }
    return of(this.fakeBooks[0]).pipe(delay(300)); // Fallback
  }

  searchBooks(searchTerm: string): Observable<BooksResponse> {
    // Используем тот же метод getBooks с параметром search
    return this.getBooks({ search: searchTerm });
  }

  createBook(book: Partial<Book>): Observable<Book> {
    // Фейковые данные
    const newBook: Book = {
      id: this.fakeBooks.length + 1,
      title: book.title || 'Новая книга',
      author: book.author || 'Неизвестный автор',
      description: book.description || '',
      cover_image: book.cover_image || 'https://via.placeholder.com/300x400',
      pages: book.pages || 0,
      language: book.language || 'ru',
      rating: book.rating || 0,
      category_id: book.category_id
    };
    this.fakeBooks.push(newBook);
    return of(newBook).pipe(delay(300));
  }

  updateBook(id: number, book: Partial<Book>): Observable<Book> {
    // Фейковые данные
    const index = this.fakeBooks.findIndex(b => b.id === id);
    if (index !== -1) {
      this.fakeBooks[index] = { ...this.fakeBooks[index], ...book };
      return of(this.fakeBooks[index]).pipe(delay(300));
    }
    return of(this.fakeBooks[0]).pipe(delay(300)); // Fallback
  }

  deleteBook(id: number): Observable<void> {
    // Фейковые данные
    const index = this.fakeBooks.findIndex(b => b.id === id);
    if (index !== -1) {
      this.fakeBooks.splice(index, 1);
    }
    return of(undefined).pipe(delay(300));
  }
}

